{"ast":null,"code":"var __jsx = React.createElement;\n\nfunction _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }\n\nimport React from \"react\";\nimport axios from \"axios\";\nimport SelForm from \"../../../components/SelForm\";\nimport { setSessionData, makeOnlyConnectionRequest, addSetToSelection, setStepperSteps, setEndpoint, setBaseUrl // setServerSessionId,\n, completeDIDAuth, makeSealSession, makeSessionWithDIDConnecetionRequest, setSealSession, setEidasUriPort, setEidasRedirectUri } from \"../../../store\";\nimport Layout from \"../../../components/Layout\";\nimport { connect } from \"react-redux\";\nimport { Button, Row, Col, Card, Container } from \"react-bootstrap\";\nimport MyStepper from \"../../../components/Stepper\";\nimport HomeButton from \"../../../components/HomeButton\";\nimport IssueVCButton from \"../../../components/IssueVCButton\";\nimport PairOrCard from \"../../../components/PairOrCard\";\nimport isMobile from \"../../../helpers/isMobile\";\nimport ConnectMobile from \"../../../components/ConnectMobile\";\n\nconst transport = require(\"uport-transports\").transport;\n/*\n  Secure flow:\n  - check in session if DID is present. This is not only the DID of the user but the whole connection response\n  - if it is not present:\n    - first display DID connection request (QR etc.). The DID response endpoint should contain the session here\n    - on response on the server, send a SSE to the front end, denoting that DID auth is completed and on the server there is the DID component\n    - Display additional datasources\n    - on VC issance request, do not display QR code etc, but send the credentials straigth to the users wallet\n\n*/\n\n\nclass IssueAmka extends React.Component {\n  constructor(props) {\n    super(props);\n\n    _defineProperty(this, \"submit\", values => {\n      // print the form values to the console\n      let valueAttributesNames = [\"oaedid\", \"hospitalized\", \"hospitalizedSpecific\", \"monk\", \"luxury\", \"none\", \"employed\"];\n      valueAttributesNames.forEach(name => {\n        if (!values[name]) {\n          values[name] = \"false\";\n        }\n      });\n      console.log(values); // values.loa = \"low\";\n\n      if (values.employed) {\n        values.employmentStatus = \"employed\";\n      } else {\n        values.employmentStatus = \"unemployed\";\n      }\n\n      values.source = \"self\";\n      let toSelect = [values];\n      this.props.setSefToSelection(toSelect);\n      axios.post(\"../../self/store\", {\n        session: this.props.sealSession,\n        details: values\n      }).then(data => {\n        console.log(\"updated backend with selection\");\n      }).then(response => {\n        this.props.setSelftToSession({\n          self: values\n        });\n      }).catch(error => {\n        console.log(error);\n      });\n    });\n\n    this.dispatch = props.dispatch;\n    this.isFetching = props.isFetching;\n    this.sessionData = props.sessionData;\n    this.hasRequiredAttributes = props.sessionData !== null && props.sessionData !== undefined && props.sessionData.self !== undefined;\n  }\n\n  static async getInitialProps({\n    reduxStore,\n    req\n  }) {\n    let userSessionData;\n    let DIDOk;\n    let sealSession;\n\n    if (true) {\n      userSessionData = req.session.userData;\n      reduxStore.dispatch(setEndpoint(req.session.enpoint));\n      let baseUrl = req.session.baseUrl ? `/${req.session.baseUrl}/` : \"\";\n      reduxStore.dispatch(setBaseUrl(baseUrl)); // reduxStore.dispatch(setServerSessionId(req.session.sealSession));\n\n      DIDOk = req.session.DID;\n      sealSession = req.session.sealSession;\n      console.log(`self.js:: in the server the seal session is:: ${req.session.sealSession}`);\n    } else {\n      if (reduxStore.getState().sessionData) {\n        userSessionData = reduxStore.getState().sessionData;\n        DIDOk = reduxStore.getState().DID; //if ther is sessionData then there should be a session as well\n\n        sealSession = reduxStore.getState().sealSession; // serverSessionId = reduxStore.getState().serverSessionId;\n      } else {\n        console.log(`no server session data found`);\n      }\n    } //this way the userSessionData gets set in all settings\n\n\n    if (userSessionData) {\n      reduxStore.dispatch(setSessionData(userSessionData));\n    }\n\n    if (DIDOk) {\n      reduxStore.dispatch(completeDIDAuth(sealSession));\n      reduxStore.dispatch(setSealSession(sealSession));\n    } //returned value here is getting mered with the mapstatetoprops\n    // mapstatetoprops overrides these values if they match\n\n\n    return {\n      sessionData: userSessionData,\n      qrData: reduxStore.getState().qrData,\n      vcSent: false,\n      sealSession: reduxStore.getState().sealSession\n    };\n  }\n\n  componentDidMount() {\n    if (this.props.sessionData && this.props.sessionData.self) {\n      let toSelect = [this.props.sessionData.amka];\n      this.props.setSefToSelection(toSelect);\n    }\n\n    if (!this.props.DID) {\n      //if DID auth has not been completed\n      if (!this.props.sealSession) {\n        this.props.startSessionAndDidAuth(this.props.baseUrl, isMobile()); //and then makeConnectionRequest\n      } else {\n        this.props.makeConnectionRequest(this.props.sealSession, this.props.baseUrl, isMobile());\n      }\n    }\n  } // componentDidUpdate() {\n  //   if (this.props.sessionData && this.props.sessionData.self) {\n  //     let toSelect = [this.props.sessionData.self];\n  //     this.props.setSefToSelection(toSelect);\n  //   }\n  // }\n\n\n  render() {\n    let stepNumber = !this.props.DID ? 0 : this.hasRequiredAttributes ? 2 : 1;\n    let stepperSteps = [{\n      title: \"Pair your wallet\"\n    }, {\n      title: \"Declare Self Attested Attributes\"\n    }, {\n      title: \"Request Issuance\"\n    }];\n\n    if (this.props.qrData && isMobile() && !this.props.DID) {\n      return __jsx(Layout, null, __jsx(Row, null, __jsx(Col, null, __jsx(MyStepper, {\n        steps: stepperSteps,\n        activeNum: stepNumber\n      }))), __jsx(ConnectMobile, {\n        baseUrl: this.props.baseUrl,\n        qrData: this.props.qrData,\n        DID: this.props.DID,\n        uuid: this.props.uuid,\n        serverSessionId: this.props.uuid,\n        sealSession: this.props.uuid\n      }));\n    }\n\n    let issueVCBut = __jsx(IssueVCButton, {\n      hasRequiredAttributes: this.props.sessionData !== null && this.props.sessionData !== undefined && this.props.sessionData.self !== undefined,\n      baseUrl: this.props.baseUrl,\n      userSelection: this.props.userSelection,\n      uuid: this.props.sealSession,\n      vcType: \"SELF\"\n    });\n\n    let selfCard = __jsx(Card, {\n      className: \"text-center\",\n      style: {\n        marginTop: \"2rem\"\n      }\n    }, __jsx(Card.Header, null, \"Issue a Verifiable Credential containing self attested attributes\"), __jsx(Card.Body, null, __jsx(Card.Title, null, this.hasRequiredAttributes ? \"Credentials Issuance is ready!\" : \"Please authenticate to the required data sources\"), __jsx(Card.Text, null, \"You have completed the self attestation of the required attributes, click the \\\"Issue\\\" button to generate and receive your VC .\"), __jsx(Container, null, __jsx(Row, null, __jsx(Col, null, issueVCBut)))));\n\n    let result = __jsx(PairOrCard, {\n      qrData: this.props.qrData,\n      DID: this.props.DID,\n      baseUrl: this.props.baseUrl,\n      uuid: this.props.uuid,\n      serverSessionId: this.props.sealSession,\n      card: selfCard,\n      vcSent: this.props.vcSent,\n      sealSession: this.props.sealSession,\n      formDataUploaded: this.props.sessionData !== null && this.props.sessionData !== undefined && this.props.sessionData.self !== undefined,\n      selfForm: __jsx(SelForm, {\n        onSubmit: this.submit\n      })\n    });\n\n    return __jsx(Layout, null, __jsx(Row, null, __jsx(Col, null, __jsx(MyStepper, {\n      steps: stepperSteps,\n      activeNum: stepNumber\n    }))), result, __jsx(Row, null, __jsx(HomeButton, {\n      baseUrl: this.props.baseUrl\n    })));\n  }\n\n}\n\nfunction mapStateToProps(state) {\n  return {\n    isFetching: state.appReducer.fetching,\n    qrData: state.appReducer.qrData,\n    sessionData: state.appReducer.sessionData,\n    userSelection: state.appReducer.userSelection,\n    // the attributes selected by the user to be included in a VC,\n    baseUrl: state.appReducer.baseUrl,\n    DID: state.appReducer.DID,\n    // serverSessionId: state.serverSessionId,\n    uuid: state.appReducer.uuid,\n    vcSent: state.appReducer.vcSent,\n    sealSession: state.appReducer.sealSession,\n    eidasUri: state.appReducer.eidasUri,\n    eidasPort: state.appReducer.eidasPort,\n    endpoint: state.appReducer.endpoint,\n    eidasRedirectUri: state.appReducer.eidasRedirectUri\n  };\n}\n\nconst mapDispatchToProps = dispatch => {\n  return {\n    setSelftToSession: userSessionData => {\n      dispatch(setSessionData(userSessionData));\n    },\n    setSefToSelection: set => {\n      dispatch(addSetToSelection(set));\n    },\n    setSteps: steps => {\n      dispatch(setStepperSteps(steps));\n    },\n    setEndPoint: endpont => {\n      dispatch(setEndpoint(endpoint));\n    },\n    makeConnectionRequest: (sealSession, baseUrl, isMobile) => {\n      dispatch(makeOnlyConnectionRequest(sealSession, baseUrl, isMobile));\n    },\n    didAuthOK: uuid => {\n      dispatch(completeDIDAuth(uuid));\n    },\n    startSealSession: baseUrl => {\n      dispatch(makeSealSession(baseUrl));\n    },\n    startSessionAndDidAuth: (baseUrl, isMobile) => {\n      dispatch(makeSessionWithDIDConnecetionRequest(baseUrl, isMobile));\n    },\n    setTheSealSession: sessionId => {\n      dispatch(setSealSession(sessionId));\n    }\n  };\n};\n\nexport default connect(mapStateToProps, mapDispatchToProps)(IssueAmka);","map":{"version":3,"sources":["/home/ni/code/js/sbchain-issuer/pages/vc/issue/self.js"],"names":["React","axios","SelForm","setSessionData","makeOnlyConnectionRequest","addSetToSelection","setStepperSteps","setEndpoint","setBaseUrl","completeDIDAuth","makeSealSession","makeSessionWithDIDConnecetionRequest","setSealSession","setEidasUriPort","setEidasRedirectUri","Layout","connect","Button","Row","Col","Card","Container","MyStepper","HomeButton","IssueVCButton","PairOrCard","isMobile","ConnectMobile","transport","require","IssueAmka","Component","constructor","props","values","valueAttributesNames","forEach","name","console","log","employed","employmentStatus","source","toSelect","setSefToSelection","post","session","sealSession","details","then","data","response","setSelftToSession","self","catch","error","dispatch","isFetching","sessionData","hasRequiredAttributes","undefined","getInitialProps","reduxStore","req","userSessionData","DIDOk","userData","enpoint","baseUrl","DID","getState","qrData","vcSent","componentDidMount","amka","startSessionAndDidAuth","makeConnectionRequest","render","stepNumber","stepperSteps","title","uuid","issueVCBut","userSelection","selfCard","marginTop","result","submit","mapStateToProps","state","appReducer","fetching","eidasUri","eidasPort","endpoint","eidasRedirectUri","mapDispatchToProps","set","setSteps","steps","setEndPoint","endpont","didAuthOK","startSealSession","setTheSealSession","sessionId"],"mappings":"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","sourcesContent":["import React from \"react\";\nimport axios from \"axios\";\nimport SelForm from \"../../../components/SelForm\";\n\nimport {\n  setSessionData,\n  makeOnlyConnectionRequest,\n  addSetToSelection,\n  setStepperSteps,\n  setEndpoint,\n  setBaseUrl,\n  // setServerSessionId,\n  completeDIDAuth,\n  makeSealSession,\n  makeSessionWithDIDConnecetionRequest,\n  setSealSession,\n  setEidasUriPort,\n  setEidasRedirectUri,\n} from \"../../../store\";\nimport Layout from \"../../../components/Layout\";\nimport { connect } from \"react-redux\";\nimport { Button, Row, Col, Card, Container } from \"react-bootstrap\";\nimport MyStepper from \"../../../components/Stepper\";\nimport HomeButton from \"../../../components/HomeButton\";\nimport IssueVCButton from \"../../../components/IssueVCButton\";\nimport PairOrCard from \"../../../components/PairOrCard\";\nimport isMobile from \"../../../helpers/isMobile\";\nimport ConnectMobile from \"../../../components/ConnectMobile\"\n\nconst transport = require(\"uport-transports\").transport;\n/*\n  Secure flow:\n  - check in session if DID is present. This is not only the DID of the user but the whole connection response\n  - if it is not present:\n    - first display DID connection request (QR etc.). The DID response endpoint should contain the session here\n    - on response on the server, send a SSE to the front end, denoting that DID auth is completed and on the server there is the DID component\n    - Display additional datasources\n    - on VC issance request, do not display QR code etc, but send the credentials straigth to the users wallet\n\n*/\n\nclass IssueAmka extends React.Component {\n  constructor(props) {\n    super(props);\n    this.dispatch = props.dispatch;\n    this.isFetching = props.isFetching;\n    this.sessionData = props.sessionData;\n    this.hasRequiredAttributes =\n      props.sessionData !== null &&\n      props.sessionData !== undefined &&\n      props.sessionData.self !== undefined;\n  }\n\n  static async getInitialProps({ reduxStore, req }) {\n    let userSessionData;\n    let DIDOk;\n    let sealSession;\n    if (typeof window === \"undefined\") {\n      userSessionData = req.session.userData;\n      reduxStore.dispatch(setEndpoint(req.session.enpoint));\n      let baseUrl = req.session.baseUrl ? `/${req.session.baseUrl}/` : \"\";\n      reduxStore.dispatch(setBaseUrl(baseUrl));\n      // reduxStore.dispatch(setServerSessionId(req.session.sealSession));\n      DIDOk = req.session.DID;\n      sealSession = req.session.sealSession;\n      console.log(\n        `self.js:: in the server the seal session is:: ${req.session.sealSession}`\n      );\n    } else {\n      if (reduxStore.getState().sessionData) {\n        userSessionData = reduxStore.getState().sessionData;\n        DIDOk = reduxStore.getState().DID;\n        //if ther is sessionData then there should be a session as well\n        sealSession = reduxStore.getState().sealSession;\n        // serverSessionId = reduxStore.getState().serverSessionId;\n      } else {\n        console.log(`no server session data found`);\n      }\n    }\n\n    //this way the userSessionData gets set in all settings\n    if (userSessionData) {\n      reduxStore.dispatch(setSessionData(userSessionData));\n    }\n    if (DIDOk) {\n      reduxStore.dispatch(completeDIDAuth(sealSession));\n      reduxStore.dispatch(setSealSession(sealSession));\n    }\n\n    //returned value here is getting mered with the mapstatetoprops\n    // mapstatetoprops overrides these values if they match\n    return {\n      sessionData: userSessionData,\n      qrData: reduxStore.getState().qrData,\n      vcSent: false,\n      sealSession: reduxStore.getState().sealSession,\n    };\n  }\n\n  componentDidMount() {\n    if (this.props.sessionData && this.props.sessionData.self) {\n      let toSelect = [this.props.sessionData.amka];\n      this.props.setSefToSelection(toSelect);\n    }\n\n    if (!this.props.DID) {\n      //if DID auth has not been completed\n      if (!this.props.sealSession) {\n        this.props.startSessionAndDidAuth(this.props.baseUrl, isMobile()); //and then makeConnectionRequest\n      } else {\n        this.props.makeConnectionRequest(\n          this.props.sealSession,\n          this.props.baseUrl,\n          isMobile()\n        );\n      }\n    }\n  }\n\n  // componentDidUpdate() {\n  //   if (this.props.sessionData && this.props.sessionData.self) {\n  //     let toSelect = [this.props.sessionData.self];\n  //     this.props.setSefToSelection(toSelect);\n  //   }\n  // }\n\n  submit = (values) => {\n    // print the form values to the console\n    let valueAttributesNames = [  \"oaedid\", \"hospitalized\", \"hospitalizedSpecific\",\"monk\", \"luxury\", \"none\", \"employed\"]\n    valueAttributesNames.forEach(name =>{\n      if(!values[name]) {\n        values[name] = \"false\";\n      }\n    })      \n    \n    console.log(values);\n    // values.loa = \"low\";\n    if(values.employed){\n      values.employmentStatus=\"employed\"\n    }else{\n      values.employmentStatus=\"unemployed\"\n    }\n    values.source = \"self\";\n    let toSelect = [values];\n\n\n\n    this.props.setSefToSelection(toSelect);\n    axios\n      .post(\"../../self/store\", {\n        session: this.props.sealSession,\n        details: values,\n      })\n      .then((data) => {\n        console.log(\"updated backend with selection\");\n      })\n      .then((response) => {\n        this.props.setSelftToSession({ self: values });\n      })\n      .catch((error) => {\n        console.log(error);\n      });\n  };\n\n  render() {\n\n    let stepNumber = !this.props.DID ? 0 : this.hasRequiredAttributes ? 2 : 1;\n    let stepperSteps = [\n      { title: \"Pair your wallet\" },\n      { title: \"Declare Self Attested Attributes\" },\n      { title: \"Request Issuance\" },\n    ];\n\n\n    if (this.props.qrData && isMobile() && !this.props.DID) {\n      return (\n        <Layout>\n          <Row>\n            <Col>\n              <MyStepper steps={stepperSteps} activeNum={stepNumber} />\n            </Col>\n          </Row>\n          <ConnectMobile\n            baseUrl={this.props.baseUrl}\n            qrData={this.props.qrData}\n            DID={this.props.DID}\n            uuid={this.props.uuid}\n            serverSessionId={this.props.uuid}\n            sealSession={this.props.uuid}\n          />\n        </Layout>\n      );\n    }\n\n    let issueVCBut = (\n      <IssueVCButton\n        hasRequiredAttributes={\n          this.props.sessionData !== null &&\n          this.props.sessionData !== undefined &&\n          this.props.sessionData.self !== undefined\n        }\n        baseUrl={this.props.baseUrl}\n        userSelection={this.props.userSelection}\n        uuid={this.props.sealSession}\n        vcType={\"SELF\"}\n      />\n    );\n\n    let selfCard = (\n      <Card className=\"text-center\" style={{ marginTop: \"2rem\" }}>\n        <Card.Header>\n          Issue a Verifiable Credential containing self attested attributes\n        </Card.Header>\n        <Card.Body>\n          <Card.Title>\n            {this.hasRequiredAttributes\n              ? \"Credentials Issuance is ready!\"\n              : \"Please authenticate to the required data sources\"}\n          </Card.Title>\n          <Card.Text>\n           You have completed the self attestation of the required attributes, click\n            the \"Issue\" button to generate and receive your VC .\n          </Card.Text>\n          <Container>\n            <Row>\n              <Col>{issueVCBut}</Col>\n            </Row>\n          </Container>\n        </Card.Body>\n      </Card>\n    );\n\n\n    let result = (\n      <PairOrCard\n        qrData={this.props.qrData}\n        DID={this.props.DID}\n        baseUrl={this.props.baseUrl}\n        uuid={this.props.uuid}\n        serverSessionId={this.props.sealSession}\n        card={selfCard}\n        vcSent={this.props.vcSent}\n        sealSession={this.props.sealSession}\n        formDataUploaded={\n          this.props.sessionData !== null &&\n          this.props.sessionData !== undefined &&\n          this.props.sessionData.self !== undefined\n        }\n        selfForm={<SelForm onSubmit={this.submit} />}\n      />\n    );\n\n    return (\n      <Layout>\n        <Row>\n          <Col>\n            <MyStepper steps={stepperSteps} activeNum={stepNumber} />\n          </Col>\n        </Row>\n        {result}\n\n        <Row>\n          <HomeButton baseUrl={this.props.baseUrl} />\n        </Row>\n      </Layout>\n    );\n  }\n}\nfunction mapStateToProps(state) {\n  return {\n    isFetching: state.appReducer.fetching,\n    qrData: state.appReducer.qrData,\n    sessionData: state.appReducer.sessionData,\n    userSelection: state.appReducer.userSelection, // the attributes selected by the user to be included in a VC,\n    baseUrl: state.appReducer.baseUrl,\n    DID: state.appReducer.DID,\n    // serverSessionId: state.serverSessionId,\n    uuid: state.appReducer.uuid,\n    vcSent: state.appReducer.vcSent,\n    sealSession: state.appReducer.sealSession,\n    eidasUri: state.appReducer.eidasUri,\n    eidasPort: state.appReducer.eidasPort,\n    endpoint: state.appReducer.endpoint,\n    eidasRedirectUri: state.appReducer.eidasRedirectUri,\n  };\n}\n\nconst mapDispatchToProps = (dispatch) => {\n  return {\n    setSelftToSession: (userSessionData) => {\n      dispatch(setSessionData(userSessionData));\n    },\n    setSefToSelection: (set) => {\n      dispatch(addSetToSelection(set));\n    },\n    setSteps: (steps) => {\n      dispatch(setStepperSteps(steps));\n    },\n    setEndPoint: (endpont) => {\n      dispatch(setEndpoint(endpoint));\n    },\n    makeConnectionRequest: (sealSession, baseUrl, isMobile) => {\n      dispatch(makeOnlyConnectionRequest(sealSession, baseUrl, isMobile));\n    },\n    didAuthOK: (uuid) => {\n      dispatch(completeDIDAuth(uuid));\n    },\n    startSealSession: (baseUrl) => {\n      dispatch(makeSealSession(baseUrl));\n    },\n    startSessionAndDidAuth: (baseUrl, isMobile) => {\n      dispatch(makeSessionWithDIDConnecetionRequest(baseUrl, isMobile));\n    },\n    setTheSealSession: (sessionId) => {\n      dispatch(setSealSession(sessionId));\n    },\n  };\n};\n\nexport default connect(mapStateToProps, mapDispatchToProps)(IssueAmka);\n"]},"metadata":{},"sourceType":"module"}